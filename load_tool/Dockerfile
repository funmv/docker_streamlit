# ë² ì´ìŠ¤ ì´ë¯¸ì§€
FROM python:3.10-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    fonts-nanum \
    libhdf5-dev \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# requirements ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Streamlit ì•± ë³µì‚¬
COPY . .

# .streamlit ë””ë ‰í† ë¦¬ ë³µì‚¬
COPY .streamlit /app/.streamlit

# ì„ì‹œ íŒŒì¼ ë° ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /tmp/streamlit /app/output && \
    chmod 777 /tmp/streamlit /app/output

# .streamlit ë””ë ‰í† ë¦¬ë¥¼ rootë¡œë„ ë³µì‚¬
RUN if [ -d ".streamlit" ]; then mkdir -p /root/.streamlit && cp -r .streamlit/* /root/.streamlit/; fi

# ğŸ”¥ Streamlit í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (íŒŒì¼ ì—…ë¡œë” ë¬¸ì œ í•´ê²°)
ENV STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_SERVER_ENABLE_CORS=false \
    STREAMLIT_SERVER_PORT=8501 \
    STREAMLIT_BROWSER_GATHER_USAGE_STATS=false \
    STREAMLIT_SERVER_FILE_WATCHER_TYPE=none \
    STREAMLIT_SERVER_ENABLE_STATIC_SERVING=false \
    STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=false \
    STREAMLIT_CLIENT_TOOLBAR_MODE=minimal \
    STREAMLIT_SERVER_MAX_UPLOAD_SIZE=200 \
    TMPDIR=/tmp/streamlit

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8501

# Health check ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# ğŸ”¥ Streamlit ì‹¤í–‰ (íŒŒì¼ ê°ì‹œ ë¹„í™œì„±í™” ì¶”ê°€)
CMD ["streamlit", "run", "main.py", \
     "--server.port=8501", \
     "--server.address=0.0.0.0", \
     "--server.maxUploadSize=5000", \
     "--server.maxMessageSize=500", \
     "--server.enableXsrfProtection=false", \
     "--server.fileWatcherType=none", \
     "--browser.gatherUsageStats=false"]